<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PSTM Test</title>
</head>

<body style="font-family:Arial;text-align:center;margin-top:40px;">

<h2>Listen and Repeat</h2>

<label>
Select your name:
<select id="student">
<option value="">-- Choose --</option>
<option>Alice</option>
<option>Bob</option>
</select>
</label>

<h3 id="itemLabel">Item 1 of 12</h3>

<button id="startBtn">START</button>
<br><br>

<audio id="audio"></audio>

<button id="recordBtn" disabled>Record</button>
<button id="stopBtn" disabled>Stop</button>
<br><br>
<button id="nextBtn" disabled>NEXT</button>

<p id="status"></p>

<script>

const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzlwo6YR-WV2NtopdtVV4JTntVhuXsOiaSRRPiiUG4xMaqsA6191PLEBHcPyuhrX2c/exec";

const audioFiles = [
"item01.mp3","item02.mp3","item03.mp3","item04.mp3",
"item05.mp3","item06.mp3","item07.mp3","item08.mp3",
"item09.mp3","item10.mp3","item11.mp3","item12.mp3"
];

let current = 0;
let recorder;
let chunks = [];
let stream;

const audio = document.getElementById("audio");
const startBtn = document.getElementById("startBtn");
const recordBtn = document.getElementById("recordBtn");
const stopBtn = document.getElementById("stopBtn");
const nextBtn = document.getElementById("nextBtn");
const status = document.getElementById("status");
const itemLabel = document.getElementById("itemLabel");

audio.controls = false;
audio.src = audioFiles[current];

navigator.mediaDevices.getUserMedia({ audio: true })
.then(s => stream = s)
.catch(() => alert("Microphone permission required"));

startBtn.onclick = async () => {

  const student = document.getElementById("student").value;

  if (!student) {
    alert("Select your name first.");
    return;
  }

  startBtn.disabled = true;
  status.innerText = "Listening...";
  await audio.play();
};

audio.onended = () => {

  status.innerText = "Record your answer";
  recordBtn.disabled = false;

  recorder = new MediaRecorder(stream);

  recorder.ondataavailable = e => chunks.push(e.data);

  recorder.onstop = () => uploadRecording();
};

recordBtn.onclick = () => {

  chunks = [];
  recorder.start();
  recordBtn.disabled = true;
  stopBtn.disabled = false;
  status.innerText = "Recording...";
};

stopBtn.onclick = () => {
  recorder.stop();
  stopBtn.disabled = true;
};

nextBtn.onclick = () => {

  current++;

  if (current < audioFiles.length) {

    audio.src = audioFiles[current];
    itemLabel.innerText = `Item ${current + 1} of 12`;

    startBtn.disabled = false;
    recordBtn.disabled = true;
    nextBtn.disabled = true;
    status.innerText = "";

  } else {

    itemLabel.innerText = "Test Completed";
    status.innerText = "Thank you.";
  }
};

function uploadRecording() {

  const studentName = document.getElementById("student").value;

  const blob = new Blob(chunks, { type: "audio/webm" });
  chunks = [];

  const reader = new FileReader();

  reader.onloadend = () => {

    const base64 = reader.result.split(",")[1];

    fetch(SCRIPT_URL, {
      method: "POST",
      body: new URLSearchParams({
        student: studentName,
        item: current + 1,
        audio: base64
      })
    })
    .then(r => r.text())
    .then(() => {
      status.innerText = "Uploaded";
      nextBtn.disabled = false;
    });
  };

  reader.readAsDataURL(blob);
}

</script>
</body>
</html>



